# PoC タスク一覧（localStorage + CSV エクスポート/インポート）

作成日: 2026-02-08  
対象仕様: `spec.md` PoC 実装方針セクション、`poc-implementation-plan.md`

このファイルは PoC（Proof of Concept）実装のための詳細なタスクリストです。各タスクには一意の ID、ステータス、優先度、見積もり、依存関係、受け入れ基準が含まれます。

## 概要

PoC の目標は、サーバを使わずに localStorage で自動スナップショット（デバウンス 2秒）を保存し、CSV エクスポート/インポート（プレビュー付き）機能を提供することです。

## タスクステータス

- `TODO`: 未着手
- `IN_PROGRESS`: 作業中
- `BLOCKED`: ブロック中（依存タスク未完了）
- `REVIEW`: レビュー待ち
- `DONE`: 完了

## マイルストーン

- **M1**: localStorage 基盤とスナップ機能（T1.1, T1.2, T1.3）- 1-2 営業日
- **M2**: CSV エクスポート機能（T2.1, T2.2）- +1 営業日
- **M3**: CSV インポート機能（T3.1, T3.2, T3.3）- +1-2 営業日
- **M4**: UI 調整・QA・ドキュメント（T4.1, T4.2, T4.3, T5.1, T5.2, T5.3）- +1-2 営業日
- **M5**: オプション機能（T6.1, T6.2, T6.3）- +2-3 営業日（任意）

---

## フェーズ 1: localStorage 基盤とスナップ機能

### T1.1: localStorage ユーティリティ関数の作成

- **ID**: T1.1
- **タイトル**: localStorage ユーティリティ関数の作成
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 1h
- **依存**: なし
- **担当**: 未割当

#### 説明
localStorage への読み書き、スナップの保存/取得/削除、ガベージコレクション（上限 25 件）を行うユーティリティ関数を作成する。

#### 成果物
- ファイル: `lib/localStorage.ts`（新規作成）
- 関数: `saveSnapshot(snap: Snapshot): void`
- 関数: `loadSnapshots(): Snapshot[]`
- 関数: `deleteSnapshot(id: string): void`
- 関数: `gcSnapshots(maxCount: number): void`
- 型定義: `Snapshot` インターフェース
  - フィールド: `id: string`, `createdAt: string`, `year: number`, `month: number`, `income: number`, `savings: number`, `rows: string[][]`, `adjLabels: string[]`, `schemaVersion: number`

#### 技術的詳細
- localStorage のキー名: `budget-snapshots` (JSON 配列として保存)
- スナップ ID: `snap-{timestamp}` 形式（例: `snap-1675835400000`）
- GC ロジック: 保存時に配列長が maxCount を超えたら、最古（createdAt が最小）のものを削除
- エラーハンドリング: localStorage が利用不可の場合は警告を console に出力

#### 受け入れ基準
- [ ] `saveSnapshot` を呼び出すと localStorage に正しく保存される
- [ ] `loadSnapshots` で保存済みスナップ配列が取得できる（新しい順にソート）
- [ ] `deleteSnapshot` で指定 ID のスナップが削除される
- [ ] `gcSnapshots(25)` で 26 件目以降の古いスナップが削除される
- [ ] ブラウザ DevTools で localStorage の内容を確認して動作を検証
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. DevTools Console で各関数を手動実行
2. localStorage の `budget-snapshots` キーを確認
3. 26 件保存して GC が動作することを確認
4. `npm run typecheck` でエラーがないことを確認

---

### T1.2: 自動保存（デバウンス 2秒）の実装

- **ID**: T1.2
- **タイトル**: 自動保存（デバウンス 2秒）の実装
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 2h
- **依存**: T1.1
- **担当**: 未割当

#### 説明
`pages/index.tsx` で useEffect を使い、フォーム state（income, savings, year, month, rows, adjLabels）の変更を監視し、デバウンス 2秒後に `saveSnapshot` を呼び出す。

#### 成果物
- `pages/index.tsx` の更新
- デバウンス用カスタムフック `useDebounce` の実装（または lodash.debounce の利用）
- useEffect 内で state 変更を監視し、デバウンス後に保存
- 保存時に `gcSnapshots(25)` を実行して上限 25 件を維持
- スナップ保存時にステータスメッセージを表示: 「自動保存しました（HH:MM:SS）」

#### 技術的詳細
- デバウンス実装: lodash.debounce または自前のカスタムフック
- 監視する state: income, savings, year, month, rows, adjLabels
- 初回レンダリング時は保存しない（useEffect の依存配列に注意）
- スナップには現在の schemaVersion（例: 1）を含める

#### 受け入れ基準
- [ ] フォーム入力を連続で行い、入力停止後 2秒で localStorage にスナップが保存される
- [ ] 保存されたスナップに正しい year, month, income, savings, rows, adjLabels が含まれる
- [ ] 26 件目以降のスナップは自動削除される
- [ ] DevTools で localStorage を確認して動作を検証
- [ ] ステータスメッセージ「自動保存しました」が表示される
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. フォームで収入を連続入力（例: 300000 → 350000 → 400000）
2. 入力停止後 2秒待つ
3. DevTools → Application → Local Storage で `budget-snapshots` を確認
4. 最新スナップに `income: 400000` が含まれることを確認
5. ステータスメッセージが表示されることを確認

---

### T1.3: ローカル履歴一覧 UI の実装

- **ID**: T1.3
- **タイトル**: ローカル履歴一覧 UI の実装
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 2-3h
- **依存**: T1.1
- **担当**: 未割当

#### 説明
右カラムの「保存済み年月」セクションをローカル履歴一覧に置き換える。各スナップを「YYYY年M月 (作成日時)」形式でボタン表示し、クリックでフォームに復元する。

#### 成果物
- `pages/index.tsx` の右カラム UI コンポーネント更新
- `loadSnapshots()` を呼び出してスナップ一覧を取得
- 各スナップボタンをクリックすると `restoreSnapshot(snap: Snapshot)` を呼び出し、フォーム state を更新
- 上部に注意書き表示:
  - 「⚠️ 自動保存は有効です。ブラウザデータの削除で履歴が消えます。重要なデータは CSV でダウンロードしてください」
- ページ初回表示時に最新のスナップを自動で読み込む（localStorage にスナップが存在する場合）

#### 技術的詳細
- スナップ一覧は新しい順に表示（createdAt でソート）
- 日時フォーマット: `new Date(snap.createdAt).toLocaleString('ja-JP')` を使用
- ボタンラベル: `${snap.year}年${snap.month}月 (${formattedDate})`
- 復元時に year/month の入力欄も更新
- CSS: `styles/Table.module.css` に `.historyList`, `.historyButton`, `.warningBox` などのクラスを追加

#### 受け入れ基準
- [ ] 右カラムに「ローカル履歴」セクションが表示される
- [ ] 注意書きが上部に表示される（⚠️ アイコン付き）
- [ ] 保存済みスナップがボタンとして一覧表示される（新しい順）
- [ ] スナップボタンをクリックするとフォームが正しく復元される
- [ ] 復元後にステータスメッセージ「履歴を復元しました」が表示される
- [ ] ページ初回表示時に最新スナップが自動で読み込まれる（スナップが存在する場合）
- [ ] TypeScript のコンパイルエラーがゼロ
- [ ] アクセシビリティ: 履歴ボタンにキーボードフォーカス時のアウトライン

#### テスト手順
1. 複数の年月でフォームを編集し、自動保存を待つ（T1.2 実装後）
2. 右カラムに履歴一覧が表示されることを確認
3. 任意のスナップをクリックしてフォームが復元されることを確認
4. 復元されたデータ（収入、貯金、カテゴリ）が正しいことを確認
5. ページをリロードして最新スナップが自動で読み込まれることを確認

---

## フェーズ 2: CSV エクスポート機能

### T2.1: CSV フォーマットと生成ロジックの実装

- **ID**: T2.1
- **タイトル**: CSV フォーマットと生成ロジックの実装
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 2h
- **依存**: T1.1
- **担当**: 未割当

#### 説明
現在のフォーム state（year, month, income, savings, rows, adjLabels）から CSV 形式のテキストを生成するユーティリティ関数を実装する。

#### CSV フォーマット仕様
- **1行目（メタ行）**: `#schemaVersion:1,year:YYYY,month:M,income:NNN,savings:NNN,createdAt:YYYY-MM-DDTHH:MM:SSZ`
- **2行目（ヘッダ行）**: `type,name,base,adj1,adj2,...`（補正列は adjLabels の実際のラベルを使用）
- **3行目以降（データ行）**: `category,食費,50000,10000,-5000,...`

#### 成果物
- ファイル: `lib/csvGenerator.ts`（新規作成）
- 関数: `generateCSV(budget: BudgetData): string`
- 型定義: `BudgetData` インターフェース（year, month, income, savings, rows, adjLabels）

#### 技術的詳細
- UTF-8 BOM 対応（Excel で文字化けしないよう `\uFEFF` を先頭に追加）
- CSV エスケープ: ダブルクォートとカンマを含むフィールドは `"` で囲み、`"` は `""` にエスケープ
- 補正列のヘッダは `adjLabels` から取得（空の場合は `adj1`, `adj2`, ... を使用）
- rows の各要素は `[type, name, base, adj1, adj2, ...]` の配列

#### 受け入れ基準
- [ ] `generateCSV` がメタ行、ヘッダ行、データ行を正しく生成する
- [ ] UTF-8 BOM が先頭に含まれる
- [ ] CSV をテキストエディタで開いて構造を確認できる
- [ ] カンマやダブルクォートを含むカテゴリ名が正しくエスケープされる
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. サンプルデータで `generateCSV` を実行
2. 生成された CSV をテキストファイルに保存
3. Excel または Google Sheets で開いて文字化けがないことを確認
4. カンマを含むカテゴリ名（例: 「光熱費,水道」）が正しく表示されることを確認
5. ダブルクォートを含むカテゴリ名（例: 「"特別"支出」）が正しく表示されることを確認

---

### T2.2: CSV ダウンロードボタンの実装

- **ID**: T2.2
- **タイトル**: CSV ダウンロードボタンの実装
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 1h
- **依存**: T2.1
- **担当**: 未割当

#### 説明
右カラムに「CSV でダウンロード」ボタンを追加し、クリックで現在のフォーム state を CSV ファイルとしてダウンロードする。

#### 成果物
- `pages/index.tsx` の更新
- ボタン UI コンポーネント（`styles/Table.module.css` に `.csvDownloadButton` クラス追加）
- クリックハンドラ: `generateCSV` を呼び出して Blob を作成し、ダウンロード
- ファイル名生成: `budget-${year}-${month.toString().padStart(2, '0')}.csv`

#### 技術的詳細
- Blob 生成: `new Blob([csvText], { type: 'text/csv;charset=utf-8;' })`
- ダウンロード: `URL.createObjectURL(blob)` と `<a>` タグの `download` 属性を利用
- ダウンロード後に Blob URL を revoke して メモリリークを防止: `URL.revokeObjectURL(url)`
- ボタンアイコン: 📥 または適切なダウンロードアイコン

#### 受け入れ基準
- [ ] 右カラムに「CSV でダウンロード」ボタンが表示される
- [ ] ボタンをクリックすると `budget-YYYY-MM.csv` がダウンロードされる
- [ ] ダウンロードした CSV を Excel で開いて内容が正しいことを確認できる
- [ ] 複数回ダウンロードしても問題がない（Blob URL のリーク確認）
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. フォームでデータを入力
2. 「CSV でダウンロード」ボタンをクリック
3. ダウンロードされた CSV ファイルを Excel で開く
4. 年月、収入、貯金、カテゴリが正しく表示されることを確認
5. 5回連続でダウンロードしてメモリリークがないことを確認（DevTools の Memory タブ）

---

## フェーズ 3: CSV インポート機能

### T3.1: CSV パーサーの実装

- **ID**: T3.1
- **タイトル**: CSV パーサーの実装
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 2-3h
- **依存**: T2.1
- **担当**: 未割当

#### 説明
アップロードされた CSV ファイルをパースして `BudgetData` 型のオブジェクトに変換するユーティリティ関数を実装する。エラー検証（スキーマバージョン不一致、必須列欠落、型不正）も含む。

#### 成果物
- ファイル: `lib/csvParser.ts`（新規作成）
- 関数: `parseCSV(csvText: string): { data: BudgetData | null, errors: string[] }`

#### パースロジック
1. 1行目のメタ行から year, month, income, savings, schemaVersion, createdAt を抽出
2. 2行目のヘッダ行から adjLabels を抽出（`adj1`, `adj2`, ... または実際のラベル）
3. 3行目以降のデータ行から rows 配列を構築

#### エラー検証
- schemaVersion が 1 以外の場合はエラー
- ヘッダ行に `type`, `name`, `base` が含まれない場合はエラー
- データ行の数値フィールド（base, adj1, ...）が数値に変換できない場合はエラー
- year または month が不正な値の場合はエラー

#### 技術的詳細
- CSV パース: シンプルな split(',') または papaparse ライブラリを使用
- ダブルクォートエスケープの処理: `"` で囲まれたフィールド内の `""` を `"` に変換
- BOM 除去: csvText の先頭が `\uFEFF` の場合は削除
- 空行は無視する

#### 受け入れ基準
- [ ] T2.1 で生成した CSV をパースして正しい `BudgetData` が得られる
- [ ] スキーマバージョン不一致の CSV で errors 配列にエラーメッセージが含まれる
- [ ] 必須列が欠けた CSV でエラーが検出される
- [ ] 数値フィールドに文字列が入った CSV でエラーが検出される
- [ ] BOM 付き CSV が正しくパースされる
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. T2.1 で生成した正常な CSV をパース → `data` が非 null、`errors` が空
2. スキーマバージョンを 2 に変更した CSV をパース → `errors` にメッセージ
3. ヘッダ行から `base` 列を削除した CSV をパース → `errors` にメッセージ
4. データ行の base に `abc` を入れた CSV をパース → `errors` にメッセージ
5. BOM 付き CSV をパースして正しく動作することを確認

---

### T3.2: CSV プレビュー画面の実装

- **ID**: T3.2
- **タイトル**: CSV プレビュー画面の実装
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 4h
- **依存**: T3.1
- **担当**: 未割当

#### 説明
CSV アップロード後に表示するプレビューモーダル（またはページ内セクション）を実装する。パース結果のサマリ（年月、カテゴリ数、補正列数）とエラーメッセージを表示し、「適用」「キャンセル」ボタンを配置する。

#### 成果物
- `pages/index.tsx` にプレビュー UI コンポーネントを追加
- `styles/Table.module.css` にモーダル用スタイル追加

#### プレビュー表示内容
- **サマリ情報**:
  - 年月: `YYYY年M月`
  - 収入: `XXX,XXX円`
  - 貯金: `XXX,XXX円`
  - カテゴリ数: `X件`
  - 補正列数: `X列`
  - 作成日時: `YYYY-MM-DD HH:MM:SS`（任意）
- **エラーメッセージ**: errors 配列が空でない場合はリスト表示
- **ボタン**:
  - 「適用」: フォーム state を更新してモーダルを閉じる
  - 「キャンセル」: モーダルを閉じるだけ

#### 技術的詳細
- モーダル実装: CSS で `position: fixed; z-index: 1000;` を使用
- 背景オーバーレイ: 半透明の黒背景、クリックで閉じない（誤操作防止）
- サマリの数値フォーマット: `toLocaleString()` でカンマ区切り
- エラーがある場合は「適用」ボタンを無効化（`disabled` 属性）
- ESC キーでモーダルを閉じる（キーボードアクセシビリティ）

#### 受け入れ基準
- [ ] CSV アップロード後にプレビュー画面が表示される
- [ ] サマリ情報（年月、収入、貯金、カテゴリ数、補正列数）が正しく表示される
- [ ] エラーがある場合は errors がリスト表示され、「適用」ボタンが無効になる
- [ ] エラーがない場合は「適用」ボタンが有効で、クリックでフォームが更新される
- [ ] 「キャンセル」ボタンでモーダルが閉じ、フォームが変更されない
- [ ] ESC キーでモーダルが閉じる
- [ ] TypeScript のコンパイルエラーがゼロ
- [ ] アクセシビリティ: モーダルに `role="dialog"` と `aria-modal="true"` を設定

#### テスト手順
1. 正常な CSV をアップロード → プレビューが表示され、「適用」が有効
2. 「適用」をクリック → フォームが更新され、モーダルが閉じる
3. 異常な CSV をアップロード → エラーメッセージ表示、「適用」が無効
4. 「キャンセル」をクリック → モーダルが閉じ、フォーム未変更
5. ESC キーを押してモーダルが閉じることを確認

---

### T3.3: CSV インポートボタンの実装

- **ID**: T3.3
- **タイトル**: CSV インポートボタンの実装
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 1h
- **依存**: T3.2
- **担当**: 未割当

#### 説明
右カラムに「CSV でインポート」ボタンを追加し、クリックで `<input type="file">` を開く。ファイル選択後に FileReader で読み込み、T3.1 のパーサーでパースし、T3.2 のプレビュー画面を表示する。

#### 成果物
- `pages/index.tsx` の更新
- ボタン UI コンポーネント（`styles/Table.module.css` に `.csvImportButton` クラス追加）
- 非表示の `<input type="file" accept=".csv">` を配置
- FileReader で CSV をテキストとして読み込み

#### 技術的詳細
- ボタンクリックで input.click() を呼び出す
- FileReader.readAsText(file, 'utf-8') を使用
- 読み込み完了後に `parseCSV(csvText)` を呼び出し
- パース結果を state に保存してプレビュー画面を表示
- ファイルサイズ制限: 10MB 以上の CSV は警告を表示（任意）
- ボタンアイコン: 📤 または適切なアップロードアイコン

#### 受け入れ基準
- [ ] 右カラムに「CSV でインポート」ボタンが表示される
- [ ] ボタンをクリックするとファイル選択ダイアログが開く
- [ ] CSV ファイルを選択するとパース処理が実行される
- [ ] パース完了後にプレビュー画面（T3.2）が表示される
- [ ] CSV ファイル以外を選択した場合は警告を表示（任意）
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. 「CSV でインポート」ボタンをクリック
2. ファイル選択ダイアログで CSV を選択
3. プレビュー画面が表示されることを確認
4. 「適用」でフォームが更新されることを確認
5. .txt ファイルを選択して警告が表示されることを確認（任意）

---

## フェーズ 4: UI/UX 調整

### T4.1: サーバ関連ボタンの非表示化

- **ID**: T4.1
- **タイトル**: サーバ関連ボタンの非表示化
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 1h
- **依存**: T1.3, T2.2, T3.3
- **担当**: 未割当

#### 説明
PoC では localStorage を使用するため、既存のサーバ保存ボタン（「保存」「策定済み予算取得」など）を非表示または無効化する。右カラムの「保存済み年月」セクションも非表示にする。

#### 成果物
- `pages/index.tsx` の更新
- 既存のサーバ関連ボタンに `display: none` または `disabled` 属性を追加
- 右カラムの「保存済み年月」セクションを非表示
- PoC モード判定用のフラグ（環境変数または定数）を追加して切り替え可能にする（任意）

#### 技術的詳細
- 環境変数 `NEXT_PUBLIC_POC_MODE=true` を設定（任意）
- または定数 `const IS_POC_MODE = true;` を `pages/index.tsx` に追加
- 条件分岐: `{!IS_POC_MODE && <button>保存</button>}`
- CSS で非表示にする場合: `.pocHidden { display: none; }` クラスを追加

#### 受け入れ基準
- [ ] フォーム上にサーバ保存ボタンが表示されない
- [ ] 右カラムに「保存済み年月」セクションが表示されない
- [ ] ローカル履歴、CSV ボタンのみが表示される
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. アプリを起動して UI を確認
2. サーバ保存関連のボタンが見えないことを確認
3. 右カラムに「ローカル履歴」「CSV でダウンロード」「CSV でインポート」のみが表示されることを確認

---

### T4.2: 注意書きメッセージの追加

- **ID**: T4.2
- **タイトル**: 注意書きメッセージの追加
- **ステータス**: TODO
- **優先度**: P1（重要）
- **見積もり**: 1h
- **依存**: T1.3
- **担当**: 未割当

#### 説明
右カラムの上部に、localStorage 使用時の注意書きメッセージを表示する。

#### メッセージ内容
「⚠️ 自動保存は有効です。ブラウザデータの削除で履歴が消えます。重要なデータは CSV でダウンロードしてください」

#### 成果物
- `pages/index.tsx` の更新
- 注意書きコンポーネント（`<div>` または `<p>`）
- `styles/Table.module.css` に `.warningBox` クラスを追加

#### 技術的詳細
- 背景色: 薄い黄色（`#fff3cd`）
- ボーダー: オレンジ色（`#ffc107`）
- アイコン: ⚠️（絵文字）または SVG アイコン
- パディング: 適度な余白で読みやすく
- レスポンシブ: モバイルでも読みやすいサイズ

#### 受け入れ基準
- [ ] 右カラム上部に注意書きが表示される
- [ ] 視認性が高い（背景色、アイコンで目立つ）
- [ ] メッセージ内容が明確で理解しやすい
- [ ] TypeScript のコンパイルエラーがゼロ
- [ ] アクセシビリティ: `role="alert"` を設定（任意）

#### テスト手順
1. アプリを起動
2. 右カラム上部に注意書きメッセージが表示されることを確認
3. 文言と視認性を確認
4. モバイルサイズでも読みやすいことを確認

---

### T4.3: レスポンシブ対応とスタイリング調整

- **ID**: T4.3
- **タイトル**: レスポンシブ対応とスタイリング調整
- **ステータス**: TODO
- **優先度**: P1（重要）
- **見積もり**: 2h
- **依存**: T1.3, T2.2, T3.3
- **担当**: 未割当

#### 説明
ローカル履歴一覧、CSV ボタン、プレビュー画面が様々なデバイスサイズで正しく表示されるよう、CSS を調整する。

#### 成果物
- `styles/Table.module.css` の更新
- メディアクエリ追加（`@media (max-width: 768px)` など）

#### 調整内容
- **PC（1920x1080）**: 左右2カラムレイアウト
- **タブレット（768x1024）**: 左右2カラム維持、右カラムの幅を調整
- **モバイル（375x667）**: 右カラムを下部に配置、またはアコーディオンで折りたたみ
- **ボタンサイズ**: タッチデバイスで押しやすいサイズ（最小 44x44px）
- **フォントサイズ**: モバイルで読みやすいサイズ（最小 14px）

#### 技術的詳細
- Flexbox または Grid レイアウトを使用
- メディアクエリのブレイクポイント: 768px, 480px
- タッチデバイス対応: `:hover` スタイルは `:active` も追加
- プレビューモーダル: モバイルでは全画面表示

#### 受け入れ基準
- [ ] PC（1920x1080）で正常表示
- [ ] タブレット（768x1024）で正常表示
- [ ] モバイル（375x667）で正常表示
- [ ] プレビュー画面がすべてのサイズで読みやすい
- [ ] ボタンがタッチデバイスで押しやすい（最小 44x44px）
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. Chrome DevTools でデバイスツールバーを開く
2. PC、タブレット、モバイルの各サイズで表示を確認
3. ボタンが押しやすく、テキストが読みやすいことを確認
4. プレビューモーダルが各サイズで正しく表示されることを確認

---

## フェーズ 5: テスト・ドキュメント

### T5.1: 単体テストの追加

- **ID**: T5.1
- **タイトル**: 単体テストの追加
- **ステータス**: TODO
- **優先度**: P1（重要）
- **見積もり**: 2h
- **依存**: T1.1, T2.1, T3.1
- **担当**: 未割当

#### 説明
localStorage ユーティリティ、CSV 生成、CSV パースの各関数に対して単体テストを追加する。Jest または Vitest を使用。

#### 成果物
- テストファイル:
  - `__tests__/lib/localStorage.test.ts`
  - `__tests__/lib/csvGenerator.test.ts`
  - `__tests__/lib/csvParser.test.ts`
- package.json に `test` スクリプトを追加

#### テストケース例
- **localStorage.test.ts**:
  - saveSnapshot → loadSnapshots で取得できる
  - deleteSnapshot で削除できる
  - gcSnapshots で古いスナップが削除される
- **csvGenerator.test.ts**:
  - 正常なデータから CSV を生成できる
  - UTF-8 BOM が含まれる
  - カンマ・ダブルクォートがエスケープされる
- **csvParser.test.ts**:
  - 正常な CSV をパースできる
  - スキーマバージョン不一致でエラー
  - 必須列欠落でエラー

#### 技術的詳細
- Jest の localStorage モック: `jest-localstorage-mock` を使用
- カバレッジ設定: `collectCoverage: true`
- カバレッジ目標: 主要関数 80% 以上

#### 受け入れ基準
- [ ] `npm test` でテストが実行される
- [ ] すべてのテストがパスする
- [ ] カバレッジレポートで主要関数が 80% 以上カバーされる
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. `npm test` を実行
2. テスト結果がすべて成功することを確認
3. カバレッジレポートを確認（`npm test -- --coverage`）

---

### T5.2: 統合テストの追加

- **ID**: T5.2
- **タイトル**: 統合テストの追加
- **ステータス**: TODO
- **優先度**: P1（重要）
- **見積もり**: 2-3h
- **依存**: T1.3, T2.2, T3.3
- **担当**: 未割当

#### 説明
PoC の主要なユーザーフロー（フォーム入力 → 自動保存 → CSV ダウンロード → CSV インポート → 復元）をシミュレートする統合テストを追加する。Playwright または Cypress を使用。

#### 成果物
- テストファイル: `e2e/poc-flow.spec.ts`
- package.json に `e2e` スクリプトを追加

#### テストシナリオ
1. フォームでデータを入力（収入、貯金、カテゴリ）
2. 2秒待って自動保存を確認（localStorage を確認）
3. ローカル履歴一覧に表示を確認
4. CSV ダウンロードボタンをクリック
5. ダウンロードした CSV を再度インポート
6. プレビュー画面で「適用」をクリック
7. フォームが正しく復元されることを確認

#### 技術的詳細
- Playwright を推奨（高速、安定）
- localStorage の検証: `page.evaluate(() => localStorage.getItem('budget-snapshots'))`
- ダウンロード検証: `page.waitForEvent('download')`
- アップロード: `page.setInputFiles('input[type="file"]', 'path/to/test.csv')`

#### 受け入れ基準
- [ ] `npm run e2e` で統合テストが実行される
- [ ] すべてのテストがパスする
- [ ] CI でも実行可能（GitHub Actions で実行）
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. `npm run e2e` を実行
2. テスト結果がすべて成功することを確認
3. CI で実行できることを確認（GitHub Actions）

---

### T5.3: README とユーザーガイドの更新

- **ID**: T5.3
- **タイトル**: README とユーザーガイドの更新
- **ステータス**: TODO
- **優先度**: P0（必須）
- **見積もり**: 1h
- **依存**: T1.3, T2.2, T3.3
- **担当**: 未割当

#### 説明
PoC の機能説明をREADME に追加し、ユーザー向けの使い方ガイド（localStorage、CSV バックアップの重要性、ブラウザデータ削除の注意）を記載する。

#### 成果物
- `README.md` の更新
- 任意: `docs/user-guide.md` の追加

#### 追加内容
- **PoC の概要**:
  - localStorage 自動保存の説明（デバウンス 2秒、上限 25件）
  - CSV エクスポート/インポートの使い方
  - 注意事項（ブラウザデータ削除リスク）
- **使い方**:
  - 1. フォームに収入・貯金・カテゴリを入力
  - 2. 自動保存されるので保存ボタンは不要
  - 3. 定期的に CSV をダウンロードしてバックアップ
  - 4. CSV をアップロードして復元可能
- **トラブルシューティング**:
  - localStorage が消えた場合の対処法
  - CSV インポートでエラーが出る場合の対処法

#### 技術的詳細
- Markdown フォーマット
- スクリーンショットの追加（任意）
- 注意書きは **太字** または 🚨 絵文字で強調

#### 受け入れ基準
- [ ] README に PoC の機能が明記されている
- [ ] CSV バックアップの重要性が強調されている
- [ ] 注意事項が読みやすく記載されている
- [ ] 使い方が明確で、新規ユーザーが理解できる

#### テスト手順
1. README.md を開いて内容を確認
2. 新規ユーザーの視点で読んで理解できるか確認
3. リンクが正しく動作することを確認（任意）

---

## フェーズ 6: オプション機能（将来対応）

### T6.1: スナップ削除機能

- **ID**: T6.1
- **タイトル**: スナップ削除機能
- **ステータス**: TODO
- **優先度**: P2（オプション）
- **見積もり**: 2h
- **依存**: T1.3
- **担当**: 未割当

#### 説明
ローカル履歴一覧の各スナップに削除ボタンを追加し、ユーザーが不要なスナップを手動で削除できるようにする。

#### 成果物
- `pages/index.tsx` の更新
- 各スナップボタンの横に削除ボタン（×アイコン）を追加
- クリックで確認ダイアログを表示 → 削除確定で `deleteSnapshot(id)` を呼び出し

#### 技術的詳細
- 削除ボタンアイコン: ❌ または SVG アイコン
- 確認ダイアログ: `window.confirm()` または カスタムモーダル
- 削除後にローカル履歴一覧を再レンダリング
- 削除後にステータスメッセージ「履歴を削除しました」を表示

#### 受け入れ基準
- [ ] 削除ボタンが各スナップの横に表示される
- [ ] 削除ボタンをクリックすると確認ダイアログが表示される
- [ ] 「OK」で削除、「キャンセル」で削除されない
- [ ] 削除後に一覧が更新される
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. 削除ボタンをクリック
2. 確認ダイアログが表示されることを確認
3. 「OK」で削除されることを確認
4. localStorage から削除されたことを確認

---

### T6.2: スナップ検索・フィルタ機能

- **ID**: T6.2
- **タイトル**: スナップ検索・フィルタ機能
- **ステータス**: TODO
- **優先度**: P2（オプション）
- **見積もり**: 3h
- **依存**: T1.3
- **担当**: 未割当

#### 説明
ローカル履歴一覧に検索ボックスを追加し、年月や作成日時でスナップをフィルタできるようにする。

#### 成果物
- `pages/index.tsx` の更新
- 検索ボックス UI（右カラム上部）
- フィルタロジック: 年月または作成日時の部分一致で一覧を絞り込む

#### 技術的詳細
- リアルタイムフィルタ（入力中に一覧が更新）
- フィルタ対象: year, month, createdAt
- 大文字小文字を区別しない
- クリアボタン: 検索ボックスをクリアするボタンを追加

#### 受け入れ基準
- [ ] 検索ボックスが表示される
- [ ] 年月（例: 「2026年2月」）を入力すると該当スナップのみ表示される
- [ ] 作成日時（例: 「2026-02-08」）で検索できる
- [ ] 検索ボックスをクリアするとすべてのスナップが表示される
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. 検索ボックスに「2026年2月」を入力
2. 該当スナップのみが表示されることを確認
3. クリアボタンで検索がリセットされることを確認

---

### T6.3: IndexedDB への移行検討

- **ID**: T6.3
- **タイトル**: IndexedDB への移行検討
- **ステータス**: TODO
- **優先度**: P2（オプション）
- **見積もり**: 4-6h
- **依存**: T1.1, T1.2, T1.3
- **担当**: 未割当

#### 説明
localStorage の 10MB 上限を超える可能性がある場合、IndexedDB への移行を検討する。PoC 後の本実装で対応。

#### 成果物
- ファイル: `lib/indexeddb.ts`（新規作成）
- IndexedDB ラッパー関数の実装
- localStorage から IndexedDB への移行スクリプト
- パフォーマンステスト

#### 技術的詳細
- IndexedDB API: idb ライブラリを使用（https://github.com/jakearchibald/idb）
- データベース名: `budget-app`
- オブジェクトストア名: `snapshots`
- キー: スナップ ID
- インデックス: year, month, createdAt

#### 受け入れ基準
- [ ] IndexedDB でスナップの保存/取得/削除ができる
- [ ] localStorage からのマイグレーションが動作する
- [ ] 大量のスナップ（100件以上）でも動作が安定している
- [ ] パフォーマンステストで localStorage と比較して遜色ない
- [ ] TypeScript のコンパイルエラーがゼロ

#### テスト手順
1. localStorage に 25 件のスナップを保存
2. マイグレーションスクリプトを実行
3. IndexedDB に移行されたことを確認（DevTools → Application → IndexedDB）
4. 100 件のスナップを保存してパフォーマンスをテスト

---

## 進捗管理

### タスクステータスサマリ（更新日: 2026-02-08）

| フェーズ | タスク | ステータス | 優先度 | 見積 | 担当 |
|---------|--------|-----------|--------|------|------|
| **フェーズ 1: localStorage 基盤** | | | | **5-6h** | |
| | T1.1 localStorage ユーティリティ | TODO | P0 | 1h | 未割当 |
| | T1.2 自動保存（デバウンス 2秒） | TODO | P0 | 2h | 未割当 |
| | T1.3 ローカル履歴一覧 UI | TODO | P0 | 2-3h | 未割当 |
| **フェーズ 2: CSV エクスポート** | | | | **3h** | |
| | T2.1 CSV フォーマット・生成ロジック | TODO | P0 | 2h | 未割当 |
| | T2.2 CSV ダウンロードボタン | TODO | P0 | 1h | 未割当 |
| **フェーズ 3: CSV インポート** | | | | **7-8h** | |
| | T3.1 CSV パーサー | TODO | P0 | 2-3h | 未割当 |
| | T3.2 CSV プレビュー画面 | TODO | P0 | 4h | 未割当 |
| | T3.3 CSV インポートボタン | TODO | P0 | 1h | 未割当 |
| **フェーズ 4: UI/UX 調整** | | | | **4h** | |
| | T4.1 サーバ関連ボタン非表示化 | TODO | P0 | 1h | 未割当 |
| | T4.2 注意書きメッセージ | TODO | P1 | 1h | 未割当 |
| | T4.3 レスポンシブ対応 | TODO | P1 | 2h | 未割当 |
| **フェーズ 5: テスト・ドキュメント** | | | | **5-6h** | |
| | T5.1 単体テスト | TODO | P1 | 2h | 未割当 |
| | T5.2 統合テスト | TODO | P1 | 2-3h | 未割当 |
| | T5.3 README 更新 | TODO | P0 | 1h | 未割当 |
| **フェーズ 6: オプション機能** | | | | **9-11h** | |
| | T6.1 スナップ削除機能 | TODO | P2 | 2h | 未割当 |
| | T6.2 スナップ検索・フィルタ | TODO | P2 | 3h | 未割当 |
| | T6.3 IndexedDB 移行検討 | TODO | P2 | 4-6h | 未割当 |

### サマリ

| カテゴリ | 値 |
|---------|-----|
| **総タスク数** | 17 |
| **TODO** | 17 |
| **IN_PROGRESS** | 0 |
| **DONE** | 0 |
| **必須タスク（P0）** | 10 |
| **重要タスク（P1）** | 4 |
| **オプション（P2）** | 3 |
| **合計見積もり** | 33-39h |
| **推定期間（フルタイム）** | 6-9 営業日 |

### 推奨実装順序

#### マイルストーン M1（必須）: localStorage 基盤とスナップ機能
- **タスク**: T1.1 → T1.2 → T1.3
- **見積もり**: 5-6h（1-2 営業日）
- **完了条件**: 
  - localStorage にスナップが自動保存される
  - ローカル履歴一覧からスナップを復元できる
  - 上限 25 件で GC が動作する

#### マイルストーン M2（必須）: CSV エクスポート
- **タスク**: T2.1 → T2.2
- **見積もり**: 3h（+1 営業日）
- **完了条件**:
  - CSV ダウンロードボタンが動作する
  - Excel で開いて正しく表示される

#### マイルストーン M3（必須）: CSV インポート
- **タスク**: T3.1 → T3.2 → T3.3
- **見積もり**: 7-8h（+1-2 営業日）
- **完了条件**:
  - CSV アップロードでプレビュー画面が表示される
  - 「適用」でフォームが正しく復元される
  - エラー検証が動作する

#### マイルストーン M4（必須）: UI/QA/ドキュメント
- **タスク**: T4.1 → T4.2 → T4.3 → T5.1 → T5.2 → T5.3
- **見積もり**: 9-10h（+1-2 営業日）
- **完了条件**:
  - サーバ機能が非表示化
  - レスポンシブ対応完了
  - 単体・統合テストが成功
  - README が更新されている

#### マイルストーン M5（オプション）: 追加機能
- **タスク**: T6.1, T6.2, T6.3（並行可能）
- **見積もり**: 9-11h（+2-3 営業日）
- **完了条件**: 各機能が動作し、ユーザーテストで問題なし

### リスクと対応

| リスク | 影響度 | 発生確率 | 対応策 |
|--------|--------|----------|--------|
| localStorage 容量超過 | 高 | 中 | CSV バックアップの強調、上限 25 件での GC |
| CSV パース失敗 | 中 | 中 | エラー検証とプレビュー画面での確認 |
| ブラウザ互換性問題 | 中 | 低 | Chrome/Safari/Firefox でテスト、polyfill 検討 |
| 既存機能とのコンフリクト | 低 | 低 | サーバ機能を非表示化、環境変数で切り替え |
| デバウンス実装の複雑さ | 低 | 中 | lodash.debounce の利用で簡素化 |

### 次のアクション

1. **今すぐ**: T1.1（localStorage ユーティリティ）から着手
2. **デイリー**: 各タスク完了後にステータスを更新
3. **週次**: 進捗レビューと優先度の再評価
4. **マイルストーンごと**: 受け入れ基準の確認と QA テスト

---

作成者: speckit.tasks  
作成日: 2026-02-08  
関連ドキュメント: `spec.md`, `poc-implementation-plan.md`
