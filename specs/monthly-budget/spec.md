# Feature: 月次家計予算策定アプリ

**Feature Branch**: `feature/monthly-budget`  
**Created**: 2026-02-07  
**Status**: Draft  
**Input**: ユーザー要望に基づく

## 概要

月ごとに固定費／変動費のカテゴリをユーザが定義し、各カテゴリに「ベース予算」と「補正予算（名目付き）」を設定して月次の予算を策定するアプリ。実支出（金額の実績）は管理せず、あくまで予算の決定と履歴保存に特化する。

主なユースケース:

- 毎月1回、収入と貯金目標を入力して配分を行う。  
- カテゴリは固定費／変動費のいずれにも属し、ユーザが複数作成可能。  
- 各カテゴリは「ベース予算」と任意の「補正予算（名目・金額）」の合算でその月の予算額が決まる。  
- 月毎の予算内訳は履歴として保存し、過去の根拠を参照できる。

## ユーザシナリオ（優先度 P1..P3）

### ユーザストーリー 1 - 月次予算の作成 (P1)

ユーザは当月の収入と貯金したい金額を入力し、カテゴリごとのベース配分を行って月次予算を作成できる。

受け入れ条件:

1. 収入を入力できる。  
2. 貯金目標を入力できる。  
3. 自動的に利用可能額 = 収入 - 貯金目標 を計算する。  
4. 利用可能額をカテゴリのベース配分（自由配分またはルールに基づく配分）で割り当て、カテゴリ毎の暫定ベース予算が表示される。  
5. 必要に応じて、各カテゴリに補正予算（名目、金額）を追加できる。  
6. 最終的な月次予算を確定すると、その内訳が履歴として保存される。

### ユーザストーリー 2 - カテゴリ管理 (P2)

ユーザは固定費／変動費のカテゴリを追加・編集・削除できる。カテゴリには名前、種別（固定/変動）、デフォルトのベース予算の推奨値を設定できる。

受け入れ条件:

1. カテゴリの作成・編集・削除ができる。  
2. カテゴリは固定／変動のいずれかを選択できる。  
3. デフォルトベース予算を設定しておけば、月次の初期配分時に候補値として表示される。

### ユーザストーリー 3 - 履歴参照 (P2)

過去の月次予算（収入・貯金目標・カテゴリ内訳・補正予算の名目）を一覧/参照できる。

受け入れ条件:

1. 月ごとの履歴一覧が見られる。  
2. 任意の月を選び、その月の各カテゴリのベース予算と補正予算（名目と金額）を閲覧できる。

## 要件

### 機能要件

- FR-001: ユーザは当月の収入を入力できること。  
- FR-002: ユーザは貯金目標額を入力できること。  
- FR-003: 利用可能額 = 収入 - 貯金目標 を自動計算すること。  
- FR-004: 利用可能額をカテゴリに配分するインターフェースを提供すること（手動配分と自動割当どちらも可）。  
- FR-005: カテゴリに補正予算（名目・金額）を追加でき、その月のカテゴリ予算へ加算されること。  
- FR-006: 月次で確定した予算は履歴として保存され、編集履歴/根拠を保持すること。  
- FR-007: カテゴリ管理（作成・編集・削除）が可能であること。  
- FR-008: 実支出（実績）は管理しないこと（設計上 MANDATORY: exclude actuals）。

### 非機能要件

- NF-001: 技術選定は要件（性能、運用コスト、チームスキル、保守性、デプロイ環境）に基づき行うこと。選定理由はスペック内に記載し、代替案とトレードオフを明示すること。
- NF-002: データは軽量な永続化でよい（例: SQLite またはシンプルなファイルストア）。  
- NF-003: ユーザインターフェースはシンプルを重視する（最小の操作で予算が決められること）。  
- NF-004: 個人情報や機密情報は暗号化/安全な保管を検討すること。

#### 推奨技術スタック（要件により選択）

小規模かつ迅速な MVP を優先する場合の推奨（参考）：

- Option A (推奨): Python 3.10+ + FastAPI + SQLite + シンプルなフロント（HTML/JS）
  - 理由: 開発速度が速く、型注釈/ドキュメント生成が容易。小規模のデータ永続化にSQLiteで十分。Pythonに習熟したチームなら最短でMVPを作れる。

- Option B: Node.js + Fastify/Express + SQLite または低コストホスティング
  - 理由: フロントエンドと同一言語で揃えたい場合や、JavaScriptエコシステムに依存する場合に有利。

- Option C: クライアント側のシングルページアプリ（静的ホスティング）+ localStorage/IndexedDB
  - 理由: 認証や多ユーザが不要で、オフライン対応が重要ならライトウェイトで実装可能。

上記はあくまで推奨であり、最終選定はチームのスキルと運用要件に従って行うこと。

## キーとなるエンティティ

- Category
  - id, name, type (fixed|variable), default_base_amount, notes
- Adjustment (補正予算)
  - id, category_id, month, label, amount
- MonthlyBudget (月次予算の確定レコード)
  - id, year, month, income, savings_goal, total_available, created_at, note
- MonthlyBudgetItem (各カテゴリの当月割当)
  - id, monthly_budget_id, category_id, base_amount, adjustments_total, final_amount

## データフロー（簡潔）

1. ユーザが収入と貯金目標を入力する。  
2. システムは利用可能額を計算する。  
3. 利用可能額をカテゴリに初期配分（デフォルト値 / 前月の比率 / 手動）する。  
4. ユーザは各カテゴリに補正予算を追加（名目・金額）。  
5. 最終合計を確認して確定すると、MonthlyBudget と MonthlyBudgetItem が保存される。

## 成功基準（測定可能）

- SC-001: ユーザが 5 分以内に月次予算を作成できる（UIの操作回数と所要時間を想定）。  
- SC-002: 月次予算確定後、履歴から任意の過去月の内訳を参照できること。  
- SC-003: カテゴリのCRUDが問題なく実行できること。

## エッジケース / 例外

- 収入 < 貯金目標: システムは警告を表示し、貯金目標の再設定を促す。  
- 利用可能額が負の場合、カテゴリ配分をゼロベースに戻すか、赤字警告を表示する。  
- 補正予算の合計が大きく、合計が利用可能額を超える場合、合計超過の警告を表示する。

## Minimal UI / 操作フロー（提案）

1. ホーム: 過去月の履歴サマリと「今月の予算を作成」ボタン。  
2. 予算作成フォーム: 収入、貯金目標、カテゴリ一覧（ベース金額表示、編集可）、補正予算の追加フォーム（名目+金額）。  
3. 確認画面: カテゴリ毎の最終金額と合計の検証、確定ボタン。  
4. 履歴画面: 月次の内訳詳細を表示。

## 次のステップ（提案）

1. 優先する UI（CLI or Web）を決める。軽量ならまず CLI、ユーザ向けなら小さな Web UI（Flask/FastAPI + シンプルなフロント）を提案。  
2. 最小実装範囲（MVP）を決める：カテゴリCRUD + 月次作成 + 履歴保存。  
3. その後、データ永続化方式（SQLite vs ファイル）を確定して実装に移行。

---

作成者: speckit.specify (auto-generated draft)
