# 月次家計予算（高レベル仕様）

作成日: 2026-02-07

このドキュメントはプロダクトやチームメンバー向けの高レベルな仕様を示します。実装の技術的な詳細（使用する言語、フレームワーク、データベースの種類など）は含めません。目的は「何を実現するか」を明確にすることです。

## 概要

ユーザが毎月の収入と貯金目標をもとに、固定費／変動費のカテゴリごとにベース予算と任意の補正予算（名目付き）を設定して月次予算を作成・保存できるアプリケーションです。実支出の管理は含みません。

主なポイント:
- 各月ごとに1つの「月次予算」を作成・保存する。既にその月の予算がある場合は上書き（編集）できる。  
- カテゴリはユーザが自由に追加・編集・削除でき、種別は「固定費」か「変動費」のいずれかであること。  
- 各カテゴリには「ベース予算」と任意の「補正（名目、金額）」を設定できる。  
- 月次予算は履歴として参照可能で、過去の内訳を確認できる。

UI 上の明確な操作（重要）:

- ユーザは「行を追加」ボタンを押すことで、予算明細（カテゴリの1行）を即座に追加できること。追加行はデフォルトで「種別=固定費、名前=空、ベース=空、補正列分は空」で挿入されること。
  - 追加した行は「行を削除」ボタンで削除可能であること。
- ユーザは「補正列を追加」ボタンを押すことで、補正予算の列をテーブルに1列追加できること。追加された補正列には任意のラベルを設定可能で、全行に空の入力欄が追加されること。
  - 追加した行は「補正列を削除」ボタンで削除可能であること。
 - 画面上に「策定済み予算取得ボタン」一覧を表示できること。各ボタンは「YYYY年M月」（例: 「2026年2月」「2026年3月」）の形式で表記され、各ボタンはその年月に策定済みの月次予算が存在する場合にのみ表示されること。
  - ユーザが該当の策定済み予算取得ボタン（例: 「2026年2月」）を押すと、ローカル履歴（localStorage のスナップショット）から当該年月の月次予算が取得され、フォーム（テーブル）に反映されて編集可能な状態になること。
  - 当該年月のスナップが存在しない場合は、その年月のボタン自体を表示しないこと。存在しない年月を選択してロードする操作は提供しない（新規作成は別操作で行う）。
- カテゴリ(つまり1行)ごとに、ベース予算と補正予算を合算した合計予算がリアルタイムで表示されること。合計予算は編集できず、表示のみであること。

- 収入-貯金目標を計算し「使えるお金」として表示すること。使えるお金から各カテゴリのベース予算と補正予算の合計を差し引いた「残額」も表示すること。残額が負の場合は明確に警告を表示すること。

- 補正列が多くなる場合は、テーブルは横スクロール可能であること。
  - 「種別」「カテゴリ名」「合計」「ベース」列は固定表示にして、補正列については左右にスクロールできるようにする。
  - その結果、列の名目表示が2列にわたったり、見切れたりしないようにして、視認性を上げる。

## レイアウト（デスクトップ・標準）

デスクトップ向けの標準レイアウトとして、編集ページは左右2カラム構成とします。左側カラムは主たる編集領域（収入・貯金目標・カテゴリテーブル・CSV エクスポート/インポート操作）を保持し、右側カラムは「ローカル履歴（スナップショット）」一覧（縦並びのボタン）を表示します。目的は編集領域の幅を確保しつつ、過去のスナップショットへ素早くアクセスできるようにすることです。

振る舞い（要点）:
- 右カラムはローカル履歴（localStorage に保存されたスナップショット）のボタンを縦に並べ、各ボタンはカラム幅に合わせてフル幅で表示する。各履歴項目は「YYYY年M月 (作成日時)」の形式で表記される。
- 左カラムはフォームとテーブルを含み、テーブルは横に広げられる場合に右カラムと並列表示される。狭い画面（モバイル）では右カラムは下部に回るか折りたたむ（簡易レスポンシブ対応）。
- 右カラムの各履歴ボタンは押下で該当スナップショットを localStorage から読み込み、左カラムのフォーム状態を置き換える（編集可能にする）。
  - ページ初回表示時に、localStorage にスナップが存在する場合は「最新のスナップ」を自動で読み込み、フォームに反映する。スナップが無い場合のみ初期シード（CSV ベース）を表示する。
- 左カラムに「CSV でダウンロード」ボタンと「CSV をインポート」ボタン（またはファイル入力）を配置する。CSV インポートはプレビュー画面（year/month、カテゴリ数、補正列数を表示）を経由して「反映」ボタンで確定する。

アクセシビリティ:
- 右カラムの領域に `aria-label="ローカル履歴"` を付与する。
- 履歴ボタンは明確なラベル（例: `2026年2月 (2026-02-08 10:30)`）を持ち、キーボードフォーカス時に視認可能なアウトラインを示す。
- 右カラム上部に注意書きを表示：「ブラウザデータの削除で履歴が消えます。重要なデータは CSV でダウンロードしてください」。



## ユーザストーリー（要点）

- P1: ユーザは当月の収入と貯金目標を入力して月次予算を作成・確定できる。  
- P2: ユーザはカテゴリの作成・編集・削除を行える（種別は固定／変動）。  
- P3: ユーザはカテゴリごとに補正予算（名目＋金額）を追加できる。  
- P4: ユーザは過去の月次予算を一覧・参照できる。

## 受け入れ基準（測定可能）

1. ユーザが指定した年と月に対して、1つの月次予算がローカルに保存されること（同じ year/month で保存すると上書きされ、複数の重複スナップが作られない）。
2. 収入・貯金目標・各カテゴリのベース・補正（名目と金額）がスナップショットとして保存・表示されること。
3. 過去月の内訳をローカル履歴から選択してその内容を閲覧できること。
4. カテゴリは固定費／変動費のいずれかを指定でき、ベースは数値で指定できること。
5. ユーザが策定済み予算取得ボタン（例: 「2026年2月」）を押すと、その年月のスナップショットがフォームにロードされ、すべての項目が編集可能になること。該当スナップが存在しない年月についてはそもそもボタンが表示されないこと。
6. ユーザが「CSV でダウンロード」ボタンを押すと、現在の状態が CSV ファイルとしてダウンロードされること。
7. ユーザが CSV ファイルをインポートすると、プレビュー画面でデータが確認でき、承認後にフォームへ反映されること。

## 非機能的な期待（大まか）

- ユーザ操作は直感的で、通常の操作フローで迷わないこと（UIはシンプルであること）。  
- 個人情報や入力データの取り扱いについては一般的な安全配慮を行うこと（必要に応じて保存ポリシーを定める）。

## UI の最小フロー（要旨）

1. ホーム画面: 過去の月次予算一覧の表示と「新規作成／編集」へ遷移するボタン。  
2. 作成画面: 収入、貯金目標、カテゴリ一覧（ベースの編集可）、補正予算の追加入力欄。  
3. 確認・保存: 作成内容を確認して確定（保存）する。  
4. 履歴画面: 過去月の内訳を一覧・参照できる。

## エッジケース（運用ルール）

- 収入 < 貯金目標: ユーザに警告を表示し、貯金目標の見直しを促す。  
- 利用可能額が負の場合は明確な警告を示す（例: 配分の見直しを促す）。  
- 補正の合計が利用可能額を超える場合は警告を表示する。

## 次のステップ（短期）

1. スペックのこの高レベル版をチームで合意する。  
2. 合意後、実装方針（実際に使うツールや保存方法）を別途決め、それを実装ドキュメントに記載する（実装文書は本スペックとは別に管理）。

## PoC 実装方針（2026-02-08 追記）

このプロジェクトでは、まず素早く安全にリリース可能な PoC（Proof of Concept）を採用します。本セクションでは、PoC の目標・保存方式・CSV 仕様・受け入れ基準を明確にします。**実装作業は別タスクで行うため、ここでは仕様の確定のみを目的とします。**

### 背景と目的

- **対象ユーザ**: 夫婦など、月1回程度の頻度で予算を編集する小規模なユースケース。
- **目標**: サーバを使わずに、ユーザが手軽に月次予算を作成・保存・復元できること。同時に、データ消失リスクを低減するためのバックアップ機能（CSV エクスポート/インポート）を提供する。

### 主要方針

1. **保存方式**: ブラウザの localStorage を利用した「自動スナップショット（フルスナップショット）」を採用する。将来的に必要があれば IndexedDB へ移行可能とする。
2. **自動保存**: フォーム内容が変更された後、**デバウンス（2秒）** を経て自動的にスナップショットを localStorage へ保存する。ユーザが明示的に保存操作をしなくても、編集内容が安全網として保持される。
3. **履歴管理**: 最新 N 件（推奨：**25件**）のスナップショットを保持し、上限を超えた場合は最古のものから自動削除する（ガベージコレクション）。各スナップには作成日時（ISO 8601形式）と year/month のメタデータを含める。
4. **エクスポート/インポート**: ユーザは任意のタイミングで現在の状態を CSV 形式でダウンロードできる。また、過去に保存した CSV をアップロードして復元できる。**アップロード時はプレビュー画面を表示**し、内容を確認・検証してからフォームに反映する。

### CSV 仕様（簡易フォーマット）

- **メタ行（先頭行）**: `#` で始まるコメント行としてスキーマバージョン、作成日時、year/month、income、savings を記載する。  
  例: `#schemaVersion:1,year:2026,month:2,income:300000,savings:50000,createdAt:2026-02-08T10:30:00Z`
- **ヘッダ行（2行目）**: `type,name,base,adj1,adj2,...` の形式。補正列（adj1, adj2, ...）は可変長で、実際の補正列数に応じて動的に増減する。各補正列のラベルはヘッダに含める。
- **データ行（3行目以降）**: 各カテゴリ（行）のデータ。空セルは空文字列として扱う。
- **エンコーディング**: UTF-8。Excel で開く際の文字化けを避けるため、**UTF-8 BOM を付与**することを UI の注意書きで推奨する。

**CSV サンプル（例）**:
```csv
#schemaVersion:1,year:2026,month:2,income:300000,savings:50000,createdAt:2026-02-08T10:30:00Z
type,name,base,ディズニー旅行,飲み会
固定費,家賃,200000,,
固定費,光熱費,5000,,
変動費,趣味・娯楽,20000,10000,
変動費,交際費,10000,,60000
```

### 検証・受け入れ基準（PoC）

1. **自動スナップ保存**: フォーム変更後にデバウンス 2秒以内に localStorage へスナップショットが保存される。デバウンスが正しく機能していることを目視で確認できる（連続入力中は保存が遅延し、入力停止後 2秒で保存される）。
2. **履歴一覧と復元**: スナップ一覧 UI から過去のスナップを選択すると、該当スナップの内容がフォームに復元される（income, savings, year, month, rows, adjLabels すべてが反映される）。
3. **CSV ダウンロード**: 「CSV でダウンロード」ボタンを押すと、現在の状態が CSV 形式でダウンロードされる。生成された CSV ファイルをテキストエディタで開き、UTF-8 で正しくエンコードされ、フォーマットがサンプルと一致することを確認する。
4. **CSV アップロード（プレビュー付き）**: ファイル選択で CSV をアップロードすると、プレビュー画面に year/month、カテゴリ数、補正列数、差分（あれば）が表示される。ユーザが「反映」ボタンを押すとフォームに取り込まれる。破損した CSV（不正フォーマット、欠損フィールド）をアップロードした場合は、エラーメッセージを表示してフォームを上書きしない。
5. **ガベージコレクション**: スナップ保存件数が設定上限（例：25件）を超えた場合、最古のスナップが自動削除される。上限を超えて保存した後、localStorage の内容を確認し、古いスナップが削除されていることを確認する。

### UI 推奨（PoC）

#### 左カラム（編集エリア）
- **「CSV でダウンロード」ボタン**: 現在の状態を CSV としてダウンロードする。ファイル名には year-month と timestamp を含める（例: `budget-2026-02-20260208T103000.csv`）。
- **「CSV をインポート」ボタン**（またはファイル入力）: CSV ファイルを選択するとプレビュー画面が表示される。プレビューには以下を表示する：
  - year/month、収入、貯金目標
  - カテゴリ数と補正列数
  - 既存データとの差分（任意）
  - 「反映」ボタンと「キャンセル」ボタン

#### 右カラム（履歴エリア）
- PoC では、従来の「保存済み年月（サーバから取得）」リストを非表示または削除し、代わりに「ローカル履歴（localStorage スナップ一覧）」を表示する。
- 各履歴項目は「YYYY年M月 (作成日時)」の形式で表示し、クリックするとフォームに復元する。
- 履歴一覧の上部に「自動保存は有効です」等の説明文を表示し、localStorage が消える可能性を注意書きで明示する（例：「ブラウザデータの削除で履歴が消えます。重要なデータは CSV でダウンロードしてください」）。

### 運用上の注意

- **localStorage の制約**: localStorage はブラウザやユーザの操作（閲覧データの消去、プライベートモード）で削除される可能性がある。そのため、**UI および README に「定期的に CSV をダウンロードしてバックアップすることを推奨する」旨の文言を明記**する。
- **容量制限**: localStorage の容量は一般的に 5〜10 MB 程度。スナップ25件を想定した場合、1件あたり数 KB 程度で十分収まる見込みだが、カテゴリ数や補正列数が極端に多い場合は容量オーバーのリスクがある。将来的に必要であれば IndexedDB への移行を検討する。
- **バージョン管理**: CSV とスナップには `schemaVersion` を含め、将来フォーマットが変更された場合のマイグレーション対応を可能にする。

### 次のアクションアイテム（実装前）

1. 本 PoC 仕様をチームでレビューし合意する。
2. 実装担当者が `pages/index.tsx` に localStorage 自動スナップ機能と CSV エクスポート/インポート UI を追加する（別タスク）。
3. 受け入れ基準に基づいた手動テスト（QA）を実施し、問題があれば修正する。
4. README と UI 内ヘルプを更新して、運用方針（サーバ保存は行わない、CSV バックアップ推奨）を明記する。

---

作成者: speckit.specify（高レベル仕様）  
更新日: 2026-02-08（PoC 方針追記）
