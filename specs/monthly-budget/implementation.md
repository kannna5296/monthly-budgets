## 月次家計予算アプリ — 現在の実装仕様

作成日: 2026-02-07

このドキュメントはワークスペース内で現在実装されている機能・UI・バリデーションと API 契約を簡潔にまとめたものです。主にフロント側（`pages/index.tsx`）の表エディタと、保存先 API（`/api/budgets`）に関する仕様を記載します。

## 目的
- チームメンバーや将来の実装者が、現在の動作（UI、入力制約、API シェイプ）を素早く把握できるようにする。

## 範囲（Scope）
- フロントエンド: `pages/index.tsx` に実装された表形式エディタ（カテゴリ編集）
- バリデーション: フロントエンドによる簡易バリデーション（必須チェック・数値チェック）
- API: `pages/api/budgets.ts` にある GET/POST の簡易ファイル保存 API

## ユーザ操作（現在の UI 動作）
- カテゴリは表形式で編集する。列は次の順: 種別, カテゴリ名, ベース予算, 補正列（0個以上）
- 種別はドロップダウンで固定値のみ選択可能:
  - `固定費`
  - `変動費`
  行追加時の既定値は `固定費`。
- カラムヘッダの補正名は編集可能（任意の文字列）で、補正列を追加／削除できる。
- 各セルは直接編集可能。
  - 種別列: セレクト（固定費／変動費）
  - カテゴリ名列: テキスト
  - ベース列: type="number"（数値入力）
  - 補正列: type="number"（数値入力）
- 行操作: 行追加、行削除が可能。補正列の追加／削除も可能。

## フロントエンド検証ルール（現行）
送信（保存）時に次をチェックし、違反があれば POST を中止してステータス表示でエラーを通知します。

- 各行の `種別` は厳密に `固定費` か `変動費` のいずれかでなければならない。
- 各行の `ベース予算` は空であってはならず、数値であること（Number に変換して NaN ではないこと）。
- 補正列に入力がある場合、その値は数値であること（空は許容されるが、非数値はエラー）。

備考: これらはフロント側の簡易チェックです。サーバ側での厳密なスキーマ検証（例: Zod）を強く推奨します。

## データモデル（フロント ↔ API の契約）

POST /api/budgets に送信される JSON の形（現在の実装）:

例: 送信ペイロード

```json
{
  "income": 300000,
  "savingsGoal": 50000,
  "year": 2026,
  "month": 2,
  "categories": [
    {
      "type": "固定費",
      "name": "家賃",
      "base": 80000,
      "adjustments": [ { "label": "ディズニー旅行", "amount": 10000 } ]
    },
    {
      "type": "変動費",
      "name": "趣味・娯楽",
      "base": 20000,
      "adjustments": []
    }
  ]
}
```

保存先の内部レコード例（`/api/budgets` が `data/budgets.json` に append する形）:

```json
{
  "id": 1675730000000,
  "createdAt": "2026-02-07T12:34:56.000Z",
  "income": 300000,
  "savingsGoal": 50000,
  "categories": [ ... ]
}
```

レスポンス:
- GET /api/budgets: 保存済みの配列を返す（空配列を返す可能性あり）
- POST /api/budgets: 成功時は 200 番台、失敗時はエラーメッセージ（現状は簡易実装）

## 保存方式（現状）
- シンプルなファイルベースの永続化（`data/budgets.json` を読み書き）を使用する MVP 実装となっています。

## 設計決定: 永続化方式は JSON ファイルを採用

決定: 本プロジェクトの MVP では永続化方式として JSON ファイル（`data/budgets.json`）を採用することを正式決定とします。

理由（短く）:
- ローカル／単一ユーザでの運用を想定しており、トランザクションや高並行性を必要としないため、ファイル保存で十分である。
- 実装とデバッグが容易で、データの中身を直接目視・編集できるので開発速度が向上する。
- 外部 DB を導入するコスト（セットアップ、ネイティブビルド、運用）はこの MVP には過剰である。

トレードオフ / 注意点:
- 同時書き込み（複数プロセスやリクエストの並行書き込み）が発生する環境では競合・データ消失のリスクがある。現在の想定（ローカル開発・単一ユーザ）では許容範囲だが、将来的に複数ユーザで同時編集する場合はファイルロックや DB への移行を検討する必要がある。
- 検索や複雑なクエリ、スキーマ進化を頻繁に行う場合は JSON のままでは不便になるため、要件に応じて SQLite/Postgres 等への移行を推奨する。

移行方針（将来のための最低限の案）:
- まずは簡単なマイグレーションスクリプトを用意し、`data/budgets.json` の各レコードを新しいストレージ（例: SQLite）にインポートできるようにする。
- 古いレコードに `year`/`month` が無い場合は、作成日時やファイル内順序を参照して推定するオプションを用意する。自動推定を行う前にバックアップを作成すること。

この設計決定は今後の要件次第で見直します。コストと運用リスクが増加したら DB 移行を検討します。

## 実行 / 動作確認手順

1. 依存をインストール（必要な場合）:

```bash
npm install
```

2. 開発サーバ起動:

```bash
npm run dev
```

3. ブラウザで http://localhost:3000 を開き、カテゴリ表の編集→「保存」で挙動を確認する。

テストするポイント:
- 「行を追加」で追加される行の `種別` が `固定費` であること。
- 種別は `固定費` / `変動費` のみ選べること（空選択なし）。
- ベース列に空または非数値を入れて保存するとフロントでエラーになること。
- 補正列に非数値を入れて保存するとフロントでエラーになること。

## 注意点・今後の改善候補

1. サーバ側バリデーション: 受信データに対して Zod 等で厳密にチェックする（必須）
2. 入力 UX 改善: 数値セルに即時バリデーション（赤枠・ツールチップ）、桁区切り表示など
3. 永続化の強化: SQLite/Postgres への移行（検索／クエリ要件が増えたら）
4. e2e/ユニットテスト: 送信処理・API を自動テストで保護する（憲法の方針に従い、テストの扱いは要検討）
5. エラー処理: API 側の失敗原因を詳細に返すようにする

---

作成者: 自動ドキュメント（現行実装の抜粋）
