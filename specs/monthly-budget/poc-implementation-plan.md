# PoC 実装計画（localStorage + CSV エクスポート/インポート）

作成日: 2026-02-08  
対象仕様: `spec.md` PoC 実装方針セクション

## 概要

本ドキュメントは、月次家計予算アプリの PoC（Proof of Concept）実装に関する詳細な実装計画を示します。PoC の目標は、サーバを使わずに localStorage で自動スナップショット（デバウンス 2秒）を保存し、CSV エクスポート/インポート（プレビュー付き）機能を提供することです。

## 前提条件

- 既存のコードベース: Next.js (pages router), React, TypeScript
- 主要ファイル: `pages/index.tsx`, `styles/Table.module.css`, `types/budget.ts`
- 現在の保存方式: サーバ API (`pages/api/budgets.ts`) 経由でファイル保存（`data/budgets.json`）
- PoC では既存のサーバ保存機能を非表示にし、localStorage ベースの機能に置き換える

## 目標と成功基準

### 目標
1. フォーム編集後 2秒で自動的に localStorage へスナップを保存する
2. 最新 25 件のスナップを保持し、古いものは自動削除する
3. CSV ダウンロード機能を提供する（UTF-8 BOM 付き、メタ行含む）
4. CSV アップロード時にプレビュー画面で内容確認し、承認後に反映する
5. 右カラムをローカル履歴一覧に置き換え、スナップをワンクリックで復元できるようにする

### 成功基準
- すべての受け入れ基準（spec.md の「検証・受け入れ基準（PoC）」5項目）が満たされる
- TypeScript のコンパイルエラーがゼロ
- 手動 QA で主要フローが動作する（編集→自動保存→復元、CSV ダウンロード→アップロード→復元）

## タスク分割と優先順位

以下、実装を段階的に進めるためのタスクリストです。各タスクには優先度（P0=必須、P1=重要、P2=推奨）、見積もり（工数：小=1h以内、中=2-4h、大=4h以上）、依存関係を記載します。

### フェーズ 1: localStorage 基盤とスナップ機能（P0）

#### T1.1 localStorage ユーティリティ関数の作成
- **優先度**: P0
- **見積もり**: 小（1h）
- **依存**: なし
- **説明**: localStorage への読み書き、スナップの保存/取得/削除、ガベージコレクション（上限 25 件）を行うユーティリティ関数を作成する。
- **成果物**: 
  - 関数: `saveSnapshot(snap: Snapshot): void`
  - 関数: `loadSnapshots(): Snapshot[]`
  - 関数: `deleteSnapshot(id: string): void`
  - 関数: `gcSnapshots(maxCount: number): void`
  - 型定義: `Snapshot` インターフェース（id, createdAt, year, month, income, savings, rows, adjLabels, schemaVersion）
- **テスト**: ブラウザ DevTools で localStorage の内容を確認し、保存/取得/削除が正しく動作することを確認

#### T1.2 自動保存（デバウンス 2秒）の実装
- **優先度**: P0
- **見積もり**: 中（2h）
- **依存**: T1.1
- **説明**: `pages/index.tsx` で useEffect を使い、フォーム state（income, savings, year, month, rows, adjLabels）の変更を監視し、デバウンス 2秒後に `saveSnapshot` を呼び出す。
- **成果物**: 
  - デバウンス用カスタムフック `useDebounce` または lodash.debounce の利用
  - useEffect 内で state 変更を監視し、デバウンス後に保存
  - 保存時に GC（ガベージコレクション）を実行して上限 25 件を維持
- **テスト**: フォームを連続編集し、入力停止後 2秒で localStorage にスナップが保存されることを DevTools で確認

#### T1.3 ローカル履歴一覧 UI の実装
- **優先度**: P0
- **見積もり**: 中（2-3h）
- **依存**: T1.1
- **説明**: 右カラムの「保存済み年月」セクションをローカル履歴一覧に置き換える。各スナップを「YYYY年M月 (作成日時)」形式でボタン表示し、クリックでフォームに復元する。
- **成果物**: 
  - 右カラムの UI コンポーネント更新（`<aside className={styles.rightCol}>` 内）
  - `loadSnapshots()` を呼び出してスナップ一覧を取得
  - 各スナップボタンをクリックすると `restoreSnapshot(snap: Snapshot)` を呼び出し、フォーム state を更新
  - 上部に注意書き表示（「自動保存は有効です。ブラウザデータの削除で履歴が消えます。重要なデータは CSV でダウンロードしてください」）
- **テスト**: 複数のスナップを保存後、履歴一覧から選択してフォームが正しく復元されることを確認

### フェーズ 2: CSV エクスポート機能（P0）

#### T2.1 CSV フォーマット生成関数の作成
- **優先度**: P0
- **見積もり**: 中（2h）
- **依存**: なし
- **説明**: 現在の state を CSV 文字列に変換する関数を作成。メタ行（`#schemaVersion:1,...`）、ヘッダ行（`type,name,base,adj1,adj2,...`）、データ行を含む。
- **成果物**: 
  - 関数: `buildCSV(state: FormState): string`
  - メタ行に schemaVersion, year, month, income, savings, createdAt を含める
  - ヘッダ行に補正列ラベルを動的に追加
  - データ行でカンマや改行を含むフィールドをクォートでエスケープ
  - UTF-8 BOM (`\uFEFF`) を先頭に付与
- **テスト**: 生成された CSV をテキストエディタで開き、フォーマットが spec.md のサンプルと一致することを確認

#### T2.2 CSV ダウンロードボタンの実装
- **優先度**: P0
- **見積もり**: 小（1h）
- **依存**: T2.1
- **説明**: 左カラムに「CSV でダウンロード」ボタンを追加し、クリックで現在の state を CSV としてダウンロードする。
- **成果物**: 
  - ボタン UI の追加（フォーム内の保存ボタン近く、または独立したセクション）
  - クリックハンドラ: `buildCSV` を呼び出し、Blob を作成して `<a>` タグで download 属性を使いダウンロード
  - ファイル名: `budget-{year}-{month}-{timestamp}.csv` 形式（例: `budget-2026-02-20260208T103000.csv`）
- **テスト**: ボタンをクリックして CSV がダウンロードされ、内容が正しいことを確認

### フェーズ 3: CSV インポート機能（P0）

#### T3.1 CSV パース関数の作成
- **優先度**: P0
- **見積もり**: 中（2-3h）
- **依存**: なし
- **説明**: アップロードされた CSV 文字列をパースし、メタデータとカテゴリデータを抽出する関数を作成。検証ロジックを含める。
- **成果物**: 
  - 関数: `parseCSV(csvText: string): ParsedCSV | { error: string }`
  - メタ行の解析（`#` で始まる行から key:value を抽出）
  - ヘッダ行の解析（補正列ラベルを動的に抽出）
  - データ行の解析（クォート処理、空セル対応）
  - 検証: 必須フィールド（schemaVersion, year, month, income）の存在チェック、数値フィールドの型チェック
  - エラーハンドリング: 不正フォーマット時はエラーメッセージを返す
- **テスト**: 正常な CSV と破損した CSV（欠損フィールド、不正フォーマット）をパースし、期待通りの結果またはエラーが返ることを確認

#### T3.2 CSV インポートプレビュー画面の実装
- **優先度**: P0
- **見積もり**: 大（4h）
- **依存**: T3.1
- **説明**: ファイル選択後、プレビュー画面をモーダルまたはインライン表示し、内容を確認後に反映する UI を実装。
- **成果物**: 
  - ファイル入力コンポーネント（`<input type="file" accept=".csv" />`）
  - onChange ハンドラで CSV を読み込み、`parseCSV` を呼び出し
  - プレビュー UI: 
    - year/month、収入、貯金目標を表示
    - カテゴリ数、補正列数を表示
    - 既存データとの差分を簡易表示（任意）
    - 「反映」ボタンと「キャンセル」ボタン
  - 「反映」ボタンクリックで state を更新し、プレビューを閉じる
  - エラー時はエラーメッセージを表示し、フォームを上書きしない
- **テスト**: 正常な CSV をアップロードしてプレビューが表示され、反映後にフォームが正しく更新されることを確認。破損した CSV をアップロードしてエラーメッセージが表示されることを確認

#### T3.3 CSV インポートボタンの追加
- **優先度**: P0
- **見積もり**: 小（1h）
- **依存**: T3.2
- **説明**: 左カラムに「CSV をインポート」ボタンを追加し、ファイル選択 UI をトリガーする。
- **成果物**: 
  - ボタン UI の追加（CSV ダウンロードボタンの近く）
  - クリックでファイル入力をトリガー（hidden input を ref で参照）
- **テスト**: ボタンをクリックしてファイル選択ダイアログが開くことを確認

### フェーズ 4: UI/UX の調整と既存機能の非表示（P1）

#### T4.1 既存のサーバ保存 UI の非表示
- **優先度**: P1
- **見積もり**: 小（1h）
- **依存**: なし
- **説明**: 既存の「保存」ボタンと右カラムの「保存済み年月」リスト（サーバから取得）を非表示または削除する。
- **成果物**: 
  - `pages/index.tsx` から `saveToServer` 呼び出しボタンを非表示（CSS で `display: none` または条件付きレンダリング）
  - 右カラムの `fetchSavedMonths` と `loadMonth` 関連 UI を非表示
  - 将来的に復活させる可能性を考慮し、コードはコメントアウトまたは条件分岐で残す
- **テスト**: UI でサーバ保存関連のボタンが表示されないことを確認

#### T4.2 CSS の調整とレスポンシブ対応
- **優先度**: P1
- **見積もり**: 中（2h）
- **依存**: T1.3, T2.2, T3.3
- **説明**: 新しい UI 要素（CSV ボタン、履歴一覧、プレビュー画面）のスタイルを調整し、レイアウトが崩れないようにする。
- **成果物**: 
  - `styles/Table.module.css` に新規クラスを追加（`.csvButton`, `.importPreview`, `.historyList` 等）
  - モバイル対応: 狭い画面では右カラムを下部に回す、またはアコーディオンで折りたたむ
- **テスト**: デスクトップとモバイル（DevTools のレスポンシブモード）でレイアウトが適切に表示されることを確認

#### T4.3 アクセシビリティの改善
- **優先度**: P1
- **見積もり**: 小（1h）
- **依存**: T1.3, T2.2, T3.2
- **説明**: ボタンやモーダルに適切な aria-label、role、キーボードナビゲーションを追加する。
- **成果物**: 
  - CSV ボタンに `aria-label="CSV でダウンロード"` を追加
  - プレビュー画面に `role="dialog"` と `aria-labelledby` を追加
  - キーボードフォーカスの管理（モーダル表示時に最初の要素にフォーカス、Esc キーで閉じる）
- **テスト**: キーボードのみで操作（Tab, Enter, Esc）して主要フローが完結することを確認

### フェーズ 5: テストとドキュメント更新（P0）

#### T5.1 受け入れ基準に基づく手動テスト（QA）
- **優先度**: P0
- **見積もり**: 中（2-3h）
- **依存**: T1.2, T1.3, T2.2, T3.2
- **説明**: spec.md の「検証・受け入れ基準（PoC）」5項目を手動で確認し、問題があれば修正する。
- **テストケース**: 
  1. フォーム編集後 2秒で localStorage にスナップが保存される（DevTools で確認）
  2. 履歴一覧から過去スナップを選択してフォームが復元される
  3. CSV ダウンロードで正しいフォーマットのファイルが生成される
  4. CSV アップロードでプレビュー表示→反映が正しく動作し、破損ファイルはエラー表示
  5. スナップ上限（25件）を超えると最古が削除される
- **成果物**: テスト結果レポート（Markdown or チェックリスト）

#### T5.2 README の更新
- **優先度**: P0
- **見積もり**: 小（1h）
- **依存**: なし
- **説明**: README に PoC の運用方針（サーバ保存は行わない、localStorage 自動保存、CSV バックアップ推奨）を明記する。
- **成果物**: 
  - README に新セクション「データ保存について」を追加
  - localStorage の制約と CSV エクスポートの推奨を記載
  - CSV フォーマットの簡易説明を追加
- **テスト**: README をレビューし、運用方針が明確に伝わることを確認

#### T5.3 UI 内ヘルプ・注意書きの追加
- **優先度**: P1
- **見積もり**: 小（1h）
- **依存**: T1.3
- **説明**: 右カラムの履歴一覧上部と、CSV ボタン近くに注意書きを表示する。
- **成果物**: 
  - 右カラム上部: 「自動保存は有効です。ブラウザデータの削除で履歴が消えます。重要なデータは CSV でダウンロードしてください」
  - CSV セクション近く: 「CSV は UTF-8 形式です。Excel で開く場合は文字化けに注意してください」
- **テスト**: UI で注意書きが視認性良く表示されることを確認

### フェーズ 6: オプション・将来対応（P2）

#### T6.1 IndexedDB への移行準備（調査）
- **優先度**: P2
- **見積もり**: 中（2h）
- **依存**: なし
- **説明**: 将来的に localStorage の容量制限を超える場合に備え、IndexedDB への移行方法を調査し、簡易的な PoC を作成する。
- **成果物**: 
  - localForage または idb ライブラリの評価
  - 移行手順のドキュメント（簡易版）
- **テスト**: なし（調査のみ）

#### T6.2 スナップの手動削除機能
- **優先度**: P2
- **見積もり**: 小（1h）
- **依存**: T1.3
- **説明**: 履歴一覧の各スナップに「削除」ボタンを追加し、ユーザが不要なスナップを手動で削除できるようにする。
- **成果物**: 
  - 各履歴項目に「削除」ボタンを追加
  - クリックで確認ダイアログを表示し、承認後に `deleteSnapshot(id)` を呼び出し
- **テスト**: 履歴から特定のスナップを削除し、localStorage から消えることを確認

#### T6.3 CSV インポート時の差分表示（詳細版）
- **優先度**: P2
- **見積もり**: 中（2-3h）
- **依存**: T3.2
- **説明**: プレビュー画面で、アップロードされた CSV と現在のフォームの差分を詳細に表示する（追加/削除/変更されたカテゴリをハイライト）。
- **成果物**: 
  - 差分計算ロジック（カテゴリ名と金額の比較）
  - プレビュー画面に差分セクションを追加（「追加: 3件、削除: 1件、変更: 2件」等）
- **テスト**: 差分がある CSV をアップロードして、プレビューに差分が正しく表示されることを確認

## 依存関係とマイルストーン

### マイルストーン 1（必須機能完了）: T1.1 → T1.2 → T1.3
- **期限**: 実装開始から 1-2 日
- **成果**: localStorage 自動スナップと履歴一覧が動作する

### マイルストーン 2（CSV エクスポート完了）: T2.1 → T2.2
- **期限**: マイルストーン 1 完了後 1 日
- **成果**: CSV ダウンロードが動作する

### マイルストーン 3（CSV インポート完了）: T3.1 → T3.2 → T3.3
- **期限**: マイルストーン 2 完了後 1-2 日
- **成果**: CSV アップロード→プレビュー→反映が動作する

### マイルストーン 4（UI 調整・QA 完了）: T4.1 → T4.2 → T4.3 → T5.1 → T5.2 → T5.3
- **期限**: マイルストーン 3 完了後 1-2 日
- **成果**: 受け入れ基準をすべて満たし、ドキュメントが更新される

### 全体スケジュール（見積もり）
- **開発フェーズ**: 5-7 営業日（1人体制、フルタイム想定）
- **QA・修正**: 1-2 営業日
- **合計**: 6-9 営業日

## リスクと対策

### リスク 1: localStorage 容量不足
- **影響**: スナップ 25 件を保存しきれない場合、自動保存が失敗する
- **対策**: 
  - 初期実装で容量チェックを行い、上限に近づいたら警告を表示
  - 将来的に IndexedDB へ移行する準備を T6.1 で行う
- **優先度**: 中

### リスク 2: CSV パースの複雑性
- **影響**: カンマや改行を含むフィールドのエスケープ処理が不完全だとパースエラーが発生
- **対策**: 
  - 既存の CSV ライブラリ（例: papaparse）の導入を検討
  - 手動実装の場合は、十分なテストケースを用意する
- **優先度**: 高

### リスク 3: ブラウザ互換性
- **影響**: localStorage や Blob download が一部ブラウザで動作しない可能性
- **対策**: 
  - 主要ブラウザ（Chrome, Firefox, Safari, Edge）で手動テスト
  - 非対応ブラウザには警告メッセージを表示
- **優先度**: 中

### リスク 4: 既存機能との競合
- **影響**: サーバ保存機能を非表示にする際、既存のコードと干渉してバグが発生
- **対策**: 
  - T4.1 で既存機能を条件分岐で残し、将来的に復活可能にする
  - TypeScript の型チェックを活用してコンパイルエラーを防ぐ
- **優先度**: 低

### リスク 5: UX の複雑化
- **影響**: プレビュー画面やモーダルが増えることで、ユーザが混乱する
- **対策**: 
  - シンプルな UI/UX を維持し、必須操作のみを表示
  - T4.3 でアクセシビリティを改善し、キーボードナビゲーションを確保
- **優先度**: 中

## 技術スタック

- **フロントエンド**: React, TypeScript, Next.js (pages router)
- **状態管理**: React hooks (useState, useEffect)
- **ストレージ**: localStorage（将来的に IndexedDB へ移行可能）
- **CSV 処理**: 手動実装（またはオプションで papaparse ライブラリ）
- **スタイリング**: CSS Modules (`Table.module.css`)
- **テスト**: 手動 QA（将来的に Playwright や Jest で自動化可能）

## 追加の推奨事項

1. **型定義の整理**: `Snapshot` や `ParsedCSV` などの型を `types/` ディレクトリに集約し、再利用性を高める。
2. **エラーハンドリングの統一**: localStorage や CSV パースのエラーを統一的にハンドリングし、ユーザにわかりやすいメッセージを表示する。
3. **将来の拡張性**: IndexedDB や外部 DB（Supabase 等）への移行を見据え、ストレージ層を抽象化する（例: `StorageAdapter` インターフェース）。
4. **パフォーマンス監視**: デバウンス 2秒が適切か、実際の使用感を確認し、必要に応じて調整する。
5. **ドキュメントの充実**: README だけでなく、コード内コメントや JSDoc を充実させ、保守性を高める。

## まとめ

本実装計画は、PoC の目標を達成するための具体的なタスクと優先順位を示しました。フェーズ 1〜4（P0〜P1）を完了すれば、spec.md の受け入れ基準をすべて満たし、夫婦で月1回使用する小規模ユースケースに対応できる PoC が完成します。フェーズ 6（P2）はオプションですが、将来の拡張性を考慮して段階的に実装することを推奨します。

---

作成者: speckit.plan  
作成日: 2026-02-08
